@model IEnumerable<Cat_Paw_Footprint.Areas.CustomersArea.ViewModel.NotificationViewModel>
@{
    ViewData["Title"] = "é€šçŸ¥ä¸­å¿ƒ";
}


<div class="notif-wrapper">
    <!-- å·¦å´åˆ†é¡ -->
    <div class="notif-sidebar">
        <h5><i class="fa-solid fa-filter me-1"></i>é€šçŸ¥åˆ†é¡</h5>
        <ul class="notif-category" id="notifCategory">
            <li class="active" data-type="å…¨éƒ¨é€šçŸ¥"><i class="fa-solid fa-bell"></i> å…¨éƒ¨é€šçŸ¥</li>
            <li data-type="å®¢æœè¨Šæ¯"><i class="fa-solid fa-headset"></i> å®¢æœè¨Šæ¯</li>
            <li data-type="å„ªæƒ æ´»å‹•"><i class="fa-solid fa-tags"></i> å„ªæƒ æ´»å‹•</li>
            <li data-type="ç³»çµ±å…¬å‘Š"><i class="fa-solid fa-bullhorn"></i> ç³»çµ±å…¬å‘Š</li>
        </ul>
    </div>

    <!-- å³å´é€šçŸ¥å…§å®¹ -->
    <div class="notif-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-primary mb-0 d-flex align-items-center">
                <i class="fa-solid fa-bell me-2"></i>
                <span id="notifTitle">å…¨éƒ¨é€šçŸ¥</span>
            </h4>

            <button id="markAllReadBtnPage" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm">
                <i class="fa-solid fa-check-double me-1"></i> å…¨éƒ¨æ¨™ç¤ºç‚ºå·²è®€
            </button>
        </div>

        <!-- ğŸ”¹ é¡¯ç¤ºç­†æ•¸èˆ‡æœå°‹ -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="d-flex align-items-center perpage-group">
                <label class="me-2 mb-0">é¡¯ç¤º</label>
                <select id="perPageSelect" class="form-select form-select-sm">
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <span class="ms-2">ç­†è³‡æ–™</span>
            </div>

            <div class="d-flex align-items-center">
                <label for="notifSearch" class="me-2 mb-0">æœå°‹ï¼š</label>
                <div class="position-relative">
                    <input type="text" id="notifSearch" class="form-control form-control-sm pe-4" placeholder="è¼¸å…¥é—œéµå­—..." style="width:200px;">
                    <i id="clearSearchBtn" class="fa-solid fa-times position-absolute end-0 top-50 translate-middle-y me-2 text-muted" style="cursor:pointer;"></i>
                </div>
            </div>
        </div>

        <!-- ğŸ”¹ é€šçŸ¥åˆ—è¡¨ -->
        <div id="notifListArea">
            @if (Model.Any())
            {
                foreach (var item in Model)
                {
                    <div class="notif-card @(item.IsRead ? "is-read" : "")"
                         data-id="@item.NotificationID"
                         data-type="@item.Type">
                        <div class="notif-title">@item.Title</div>
                        <div class="notif-message">@item.Message</div>
                        <div class="notif-time">
                            å»ºç«‹æ–¼ @item.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                            @if (item.IsRead && item.ReadAt != null)
                            {
                                <span>ï¼ˆå·²è®€æ–¼ @item.ReadAt.Value.ToString("HH:mm")ï¼‰</span>
                            }
                        </div>
                    </div>
                }
            }

            <!-- ğŸ”¹ æç¤ºæ–‡å­—ï¼ˆç”± JS æ§åˆ¶é¡¯ç¤ºï¼‰ -->
            <div id="noNotifMsg" class="text-center text-secondary my-5" style="display:none;">
                ç›®å‰æ²’æœ‰é€šçŸ¥ ğŸ’¤
            </div>
        </div>


        <!-- ğŸ”¹ åˆ†é æ§åˆ¶ -->
        <div class="text-center mt-3" id="notifPagination">
            <button id="prevPageBtn" class="btn btn-outline-secondary btn-sm me-2 rounded-pill">ä¸Šä¸€é </button>
            <span id="pageInfo" class="text-muted"></span>
            <button id="nextPageBtn" class="btn btn-outline-primary btn-sm ms-2 rounded-pill">ä¸‹ä¸€é </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // ------------------------------
            // ğŸ”¹ åˆå§‹åŒ–è®Šæ•¸
            // ------------------------------
            let currentPage = 1;
            let perPage = 5;
            let allCards = Array.from(document.querySelectorAll(".notif-card"));
            const pageInfo = document.getElementById("pageInfo");
            const prevBtn = document.getElementById("prevPageBtn");
            const nextBtn = document.getElementById("nextPageBtn");


            // ------------------------------
            // ğŸ”¹ é¡¯ç¤ºç›®å‰é é¢çš„é€šçŸ¥
            // ------------------------------
            function showPage(page) {
                const start = (page - 1) * perPage;
                const end = start + perPage;
                const totalPages = Math.ceil(allCards.length / perPage);

                allCards.forEach((card, idx) => {
                    card.style.display = (idx >= start && idx < end) ? "block" : "none";
                });

                // æ›´æ–°é æ•¸é¡¯ç¤º
                if (pageInfo) pageInfo.textContent = `ç¬¬ ${page} / ${totalPages || 1} é `;

                // æ§åˆ¶æŒ‰éˆ•
                prevBtn.disabled = page === 1;
                nextBtn.disabled = page >= totalPages;
            }

            // ------------------------------
            // ğŸ”¹ åˆ†é æŒ‰éˆ•äº‹ä»¶
            // ------------------------------
            prevBtn.addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    showPage(currentPage);
                }
            });

            nextBtn.addEventListener("click", () => {
                const totalPages = Math.ceil(allCards.length / perPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    showPage(currentPage);
                }
            });
            // ------------------------------
            // ğŸ”¹ é¡¯ç¤ºç­†æ•¸æ”¹è®Š
            // ------------------------------
            perPageSelect.addEventListener("change", () => {
                perPage = parseInt(perPageSelect.value, 10);
                allCards = Array.from(document.querySelectorAll(".notif-card"));
                currentPage = 1;
                showPage(currentPage);
            });



            // ------------------------------
            // ğŸ”¹ æœå°‹åŠŸèƒ½ï¼ˆå³æ™‚ç¯©é¸ + æ¸…é™¤ï¼‰
            // ------------------------------
            const searchInput = document.getElementById("notifSearch");
            const clearBtn = document.getElementById("clearSearchBtn");

            searchInput.addEventListener("input", () => {
                const keyword = searchInput.value.trim().toLowerCase();
                const all = document.querySelectorAll(".notif-card");

                // é¡¯ç¤ºæˆ–éš±è—æ¸…é™¤æŒ‰éˆ•
                if (keyword.length > 0) {
                    clearBtn.style.visibility = "visible";
                } else {
                    clearBtn.style.visibility = "hidden";
                }

                // ç¯©é¸ç¬¦åˆé—œéµå­—çš„å¡ç‰‡
                all.forEach(card => {
                    const text = (card.textContent || "").toLowerCase();
                    card.style.display = text.includes(keyword) ? "block" : "none";
                });

                // æœå°‹å¾Œé‡å»º allCards é™£åˆ—ï¼ˆåªä¿ç•™é¡¯ç¤ºä¸­çš„ï¼‰
                allCards = Array.from(all).filter(c => c.style.display === "block");
                currentPage = 1;
                showPage(currentPage);
            });

            // ğŸ”¹ é»æ¸…é™¤æŒ‰éˆ• â†’ æ¸…ç©ºæœå°‹æ¡† + è§¸ç™¼æ›´æ–°
            clearBtn.addEventListener("click", () => {
                searchInput.value = "";
                clearBtn.style.visibility = "hidden";
                searchInput.dispatchEvent(new Event("input"));
            });

            // ------------------------------
            // ğŸ”¹ é»æ“Šé€šçŸ¥ -> æ¨™è¨˜å·²è®€ + å°å‘å®¢æœä¸­å¿ƒ
            // ------------------------------
            document.querySelectorAll(".notif-card").forEach(card => {
                card.addEventListener("click", async () => {
                    const id = card.dataset.id;
                    const type = card.dataset.type;
                    const message = card.querySelector(".notif-message")?.textContent || "";
                    const title = card.querySelector(".notif-title")?.textContent || "";

                    try {
                        await axios.post("/CustomersArea/Notifications/MarkAsRead", { id });
                        card.classList.add("is-read");

                        if (typeof updateUnread === "function") updateUnread();

                        // âœ… è‹¥ç‚ºå®¢æœç›¸é—œé€šçŸ¥å‰‡å°å‘å®¢æœä¸­å¿ƒ
                        if (
                            type === "å®¢æœè©•åƒ¹æé†’" ||
                            type === "å®¢æœå›è¦†" ||
                            type === "å®¢æœè¨Šæ¯" ||
                            type === "å®¢æœæœå‹™å·²å®Œæˆ"||
                            title.includes("è¨‚å–®å–æ¶ˆé€šçŸ¥")||
                            message.includes("å–æ¶ˆç”³è«‹")
                        ) 
                        {
                            const match = message.match(/#\s*(\d+)/);
                            if (match && match[1]) {
                                const ticketId = match[1];
                                window.location.href = `/CustomersArea/CustomerService/Index?ticketId=${ticketId}`;
                                return;
                        }
                        }
                        // âœ… è‹¥ç‚ºå„ªæƒ æ´»å‹•æˆ–å„ªæƒ åˆ¸é€šçŸ¥ â†’ å°å‘å„ªæƒ åˆ¸é é¢
                        if (type === "å„ªæƒ æ´»å‹•" || type === "å„ªæƒ åˆ¸é€šçŸ¥" || message.includes("å„ªæƒ åˆ¸")) {
                            window.location.href = "/CustomersArea/Coupons/Index";
                            return;
                        }
                        
                        if (type === "è¨‚å–®é€šçŸ¥" || type === "ç³»çµ±å…¬å‘Š") {
                            const match = message.match(/#\s*(\d+)/);
                            if (match && match[1]) {
                                const orderId = match[1];
                                window.location.href = `/CustomersArea/Orders?orderId=${orderId}`;
                            } else {
                                window.location.href = `/CustomersArea/Orders`;
                            }
                            return;
                        }
        
                    } catch (err) {
                        console.error("âŒ æ¨™è¨˜é€šçŸ¥ç‚ºå·²è®€å¤±æ•—", err);
                        window.showAlert('error', 'éŒ¯èª¤', 'ç„¡æ³•æ¨™è¨˜é€šçŸ¥ç‚ºå·²è®€');
                    }
                });
            });


            // ===================================================
            // ğŸ”¹ é€šçŸ¥åˆ†é¡ç¯©é¸ + åˆ†é é‡è¨­ï¼ˆå®Œæ•´ç‰ˆï¼‰
            // ===================================================
            const categoryItems = document.querySelectorAll(".notif-category li");
            const titleSpan = document.getElementById("notifTitle");

            categoryItems.forEach(cat => {
                cat.addEventListener("click", () => {

                    // ------------------------------
                    // ğŸ”¸ 1ï¸ æ›´æ–°å·¦å´åˆ†é¡é¸å–æ¨£å¼
                    // ------------------------------
                    categoryItems.forEach(c => c.classList.remove("active"));
                    cat.classList.add("active");

                    // ------------------------------
                    // ğŸ”¸ 2ï¸ å–å¾—ç›®å‰åˆ†é¡èˆ‡æ‰€æœ‰å¡ç‰‡
                    // ------------------------------
                    const type = cat.dataset.type;              // ç•¶å‰é»æ“Šåˆ†é¡
                    titleSpan.textContent = type;               // æ›´æ–°å³ä¸Šæ–¹æ¨™é¡Œæ–‡å­—
                    const notifListArea = document.getElementById("notifListArea");
                    const all = Array.from(document.querySelectorAll(".notif-card")); // å…¨éƒ¨é€šçŸ¥å¡ç‰‡

                    // å…ˆéš±è—å…¨éƒ¨å¡ç‰‡ï¼ˆç¨å¾Œå†ä¾æ¢ä»¶é¡¯ç¤ºï¼‰
                    all.forEach(card => (card.style.display = "none"));


                    // ===================================================
                    // ğŸ”¹ 3ï¸ ç¯©é¸é‚è¼¯ï¼šæ±ºå®šå“ªäº›å¡ç‰‡è¦é¡¯ç¤º
                    // ===================================================
                    const filtered = all.filter(card => {
                        const cardType = card.dataset.type; // æ¯å¼µå¡ç‰‡çš„é€šçŸ¥é¡å‹

                        // âœ… (1) å…¨éƒ¨é€šçŸ¥ â†’ é¡¯ç¤ºå…¨éƒ¨
                        if (type === "å…¨éƒ¨é€šçŸ¥") return true;

                        // âœ… (2) å®¢æœè¨Šæ¯åˆ†é¡ â†’ åŒ…å«æ‰€æœ‰å®¢æœç›¸é—œé€šçŸ¥
                        //     åŒ…å«ä»¥ä¸‹ä»»ä¸€é¡å‹éƒ½æœƒè¢«é¡¯ç¤ºï¼š
                        //     ã€Œå®¢æœè¨Šæ¯ã€ã€ã€Œå®¢æœå›è¦†ã€ã€ã€Œå®¢æœæœå‹™å·²å®Œæˆã€ã€ã€Œå®¢æœè©•åƒ¹æé†’ã€
                        if (type === "å®¢æœè¨Šæ¯") {
                            return cardType.includes("å®¢æœ");
                        }

                        // âœ… (3) å…¶ä»–åˆ†é¡ â†’ ç²¾æº–æ¯”å°é¡å‹åç¨±
                        //     ä¾‹å¦‚ã€Œå„ªæƒ æ´»å‹•ã€ã€ã€Œç³»çµ±å…¬å‘Šã€ç­‰ã€‚
                        return cardType === type;
                    });


                    // ===================================================
                    // ğŸ”¹ 4ï¸ è‹¥è©²åˆ†é¡æ²’æœ‰ç¬¦åˆé …ç›® â†’ é¡¯ç¤ºæç¤ºè¨Šæ¯
                    // ===================================================
                    let noMsg = document.getElementById("noNotifMsg");

                    // å¦‚æœæç¤ºè¨Šæ¯å…ƒç´ ä¸å­˜åœ¨ï¼Œå…ˆå»ºç«‹ä¸€å€‹
                    if (!noMsg) {
                        noMsg = document.createElement("div");
                        noMsg.id = "noNotifMsg";
                        noMsg.className = "text-center text-secondary my-5";
                        noMsg.textContent = "ç›®å‰æ²’æœ‰é€šçŸ¥ ğŸ’¤";
                        noMsg.style.display = "none";
                        notifListArea.appendChild(noMsg);
                    }

                    // è‹¥æ²’æœ‰ä»»ä½•ç¬¦åˆçš„å¡ç‰‡ â†’ é¡¯ç¤ºã€Œç›®å‰æ²’æœ‰é€šçŸ¥ ğŸ’¤ã€
                    if (filtered.length === 0) {
                        noMsg.style.display = "block";
                    } else {
                        // æœ‰è³‡æ–™ â†’ éš±è—æç¤ºï¼Œé¡¯ç¤ºå¡ç‰‡
                        noMsg.style.display = "none";
                        filtered.forEach(card => (card.style.display = "block"));
                    }


                    // ===================================================
                    // ğŸ”¹ 5ï¸ é‡æ–°æ•´ç†åˆ†é æ§åˆ¶
                    // ===================================================
                    allCards = filtered; // æ›´æ–°ç›®å‰å¯è¦‹çš„é€šçŸ¥é›†åˆ
                    currentPage = 1;     // å›åˆ°ç¬¬ä¸€é 
                    showPage(currentPage);
                    updateNoNotifMessage();
                });
            });




            // ------------------------------
            // ğŸ”¹ SignalR æ–°é€šçŸ¥æ¥æ”¶äº‹ä»¶
            // ------------------------------
            async function bindNotificationEvents() {
                if (!window.connection) {
                    console.warn("âš ï¸ å°šæœªè¼‰å…¥ webFront.jsï¼Œ2 ç§’å¾Œé‡è©¦...");
                    return setTimeout(bindNotificationEvents, 2000);
                }

                try {
                    if (window.connection.state === signalR.HubConnectionState.Disconnected) {
                        await window.connection.start();
                        console.log("âœ… é€šçŸ¥ä¸­å¿ƒå·²é€£ä¸Š SignalR");
                    }

                    window.connection.off("ReceiveNotification");
                    window.connection.on("ReceiveNotification", (title, message, type) => {
                        console.log("ğŸ“© æ”¶åˆ°é€šçŸ¥ä¸­å¿ƒè¨Šæ¯", { title, message, type });

                        const notifListArea = document.getElementById("notifListArea");
                        const now = dayjs().format("YYYY-MM-DD HH:mm");

                        const newCard = document.createElement("div");
                        newCard.className = "notif-card";
                        newCard.setAttribute("data-type", type);
                        newCard.innerHTML = `
                            <div class="notif-title">${title}</div>
                            <div class="notif-message">${message}</div>
                            <div class="notif-time">å»ºç«‹æ–¼ ${now}</div>
                        `;

                        notifListArea.prepend(newCard);
                        allCards = [newCard, ...allCards]; // æ”¾å…¥åˆ†é æ§åˆ¶é™£åˆ—
                        currentPage = 1;
                        showPage(currentPage);

                        // å‹•ç•«æ•ˆæœ
                        newCard.style.opacity = "0";
                        newCard.style.transform = "translateY(-10px)";
                        newCard.style.transition = "all 0.4s ease";
                        setTimeout(() => {
                            newCard.style.opacity = "1";
                            newCard.style.transform = "translateY(0)";
                        }, 10);

                        window.showAlert('info', title, message);
                        if (typeof updateUnread === "function") updateUnread();
                    });

                } catch (e) {
                    console.warn("âš ï¸ é€šçŸ¥ä¸­å¿ƒç„¡æ³•æ›æ¥ SignalR:", e);
                    setTimeout(bindNotificationEvents, 3000);
                }
            }

            bindNotificationEvents();
            showPage(currentPage);

            // ğŸ”¹ é é¢è¼‰å…¥æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰é€šçŸ¥ï¼Œè‹¥æ²’æœ‰å‰‡é¡¯ç¤ºæç¤º
            const noMsg = document.getElementById("noNotifMsg");
            function updateNoNotifMessage() {
                if (allCards.length === 0) {
                    noMsg.style.display = "block";
                } else {
                    noMsg.style.display = "none";
                }
            }
            updateNoNotifMessage();
            });
    </script>

}

    